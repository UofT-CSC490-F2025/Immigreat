name: Test Coverage
permissions:
  contents: read
  pull-requests: write

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.13"]
    env:
      AWS_DEFAULT_REGION: us-east-1
      AWS_REGION: us-east-1

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r src/requirements.txt
          pip install -r requirements-dev.txt

      - name: Run tests with coverage
        run: |
          pytest --cov=src --cov-report=xml --cov-report=term --cov-report=html --cov-report=json

      - name: Generate coverage comment
        if: github.event_name == 'pull_request' && matrix.python-version == '3.13'
        id: coverage
        run: |
          COVERAGE=$(python -c "import json; data=json.load(open('coverage.json')); print(f'{data[\"totals\"][\"percent_covered\"]:.2f}')")
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT

          # Generate markdown table
          python << 'EOF' > coverage-comment.md
          import json

          with open('coverage.json') as f:
              data = json.load(f)

          total = data['totals']
          files = data['files']
          coverage_pct = total['percent_covered']

          # Determine color based on coverage
          if coverage_pct >= 80:
              color = 'brightgreen'
          elif coverage_pct >= 60:
              color = 'yellow'
          else:
              color = 'red'

          # Create shields.io badge URL
          badge_url = f"https://img.shields.io/badge/coverage-{coverage_pct:.2f}%25-{color}"

          print("## Coverage Report\n")
          print(f"![Coverage]({badge_url})\n")
          print("| File | Statements | Missing | Coverage |")
          print("|------|------------|---------|----------|")

          for file_path, file_data in sorted(files.items()):
              if file_path.startswith('src/'):
                  name = file_path.replace('src/', '')
                  stmts = file_data['summary']['num_statements']
                  missing = file_data['summary']['missing_lines']
                  covered = file_data['summary']['percent_covered']
                  print(f"| {name} | {stmts} | {missing} | {covered:.2f}% |")
          EOF

      - name: Post coverage comment
        if: github.event_name == 'pull_request' && matrix.python-version == '3.13'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('coverage-comment.md', 'utf8');

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('Coverage Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

      - name: Generate coverage badge
        if: matrix.python-version == '3.13' && github.ref == 'refs/heads/main'
        run: |
          pip install coverage-badge
          coverage-badge -o coverage.svg -f

      - name: Upload coverage badge
        if: matrix.python-version == '3.13' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-badge
          path: coverage.svg

      - name: Archive coverage report
        if: matrix.python-version == '3.13'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/
          retention-days: 30
